local ReplicatedStorage = game:GetService("ReplicatedStorage")
local PlaceEvent = ReplicatedStorage:WaitForChild("PlaceItemEvent")
local GRID_SIZE = 4

local itemFolders = {
	ReplicatedStorage:WaitForChild("CraftableItems"),
	ReplicatedStorage:WaitForChild("CraftingBenchItems"),
	ReplicatedStorage:WaitForChild("Resources")
}

local playerCooldowns = {} 

local function findModel(name)
	for _, folder in ipairs(itemFolders) do
		local found = folder:FindFirstChild(name)
		if found then return found end
	end
	return nil
end

PlaceEvent.OnServerEvent:Connect(function(player, tool, targetCFrame)
	if playerCooldowns[player] and tick() - playerCooldowns[player] < 0.2 then return end
	playerCooldowns[player] = tick()

	if not tool or not tool:IsA("Tool") or typeof(targetCFrame) ~= "CFrame" then return end

	local character = player.Character
	if not character or not character:FindFirstChild("HumanoidRootPart") then return end

	if (character.HumanoidRootPart.Position - targetCFrame.Position).Magnitude > 55 then 
		return 
	end

	local toolName = tool.Name
	local isStructure = tool:GetAttribute("Structure") or false
	local sx, sy = tool:GetAttribute("SizeX") or 1, tool:GetAttribute("SizeY") or 1

	local overlapParams = OverlapParams.new()
	overlapParams.FilterType = Enum.RaycastFilterType.Exclude
	overlapParams.FilterDescendantsInstances = {character}

	local bounds = workspace:GetPartBoundsInBox(targetCFrame, Vector3.new(0.5, 0.5, 0.5), overlapParams)
	for _, part in ipairs(bounds) do
		if part:GetAttribute("Occupied") or (isStructure and part:GetAttribute("Structure")) then
			return 
		end
	end

	local sourceModel = findModel(toolName)
	if not sourceModel then return end

	local placedItem = sourceModel:Clone()

	if placedItem:IsA("Tool") then
		local newModel = Instance.new("Model")
		newModel.Name = toolName
		for _, child in ipairs(placedItem:GetChildren()) do
			if child:IsA("BasePart") or child:IsA("Model") then child.Parent = newModel end
		end
		placedItem = newModel
	else
		placedItem.Name = toolName
	end

	placedItem:PivotTo(targetCFrame)

	for _, desc in ipairs(placedItem:GetDescendants()) do
		if desc:IsA("BasePart") then 
			desc.Anchored = true
			desc.CanCollide = true
			if isStructure then 
				desc:SetAttribute("Structure", true) 
			elseif toolName == "Foundation" then
				desc.Name = "Foundation"
			end
		elseif desc:IsA("Script") or desc:IsA("LocalScript") then 
			desc:Destroy() 
		end
	end

	if not isStructure then
		local startX = targetCFrame.Position.X - (sx * GRID_SIZE / 2)
		local startZ = targetCFrame.Position.Z - (sy * GRID_SIZE / 2)

		for x = 0, sx - 1 do
			for z = 0, sy - 1 do
				local checkX = startX + (x * GRID_SIZE) + (GRID_SIZE / 2)
				local checkZ = startZ + (z * GRID_SIZE) + (GRID_SIZE / 2)
				local occRay = workspace:Raycast(Vector3.new(checkX, targetCFrame.Position.Y + 2, checkZ), Vector3.new(0, -5, 0))
				if occRay and occRay.Instance.Name == "Grass" then 
					occRay.Instance:SetAttribute("Occupied", true) 
				end
			end
		end
	end

	local amount = tool:GetAttribute("Amount") or 1
	if amount > 1 then
		tool:SetAttribute("Amount", amount - 1)
	else
		tool:Destroy()
	end

	local container = workspace:FindFirstChild("PlacedStructures") or Instance.new("Folder", workspace)
	container.Name = "PlacedStructures"
	placedItem.Parent = container
end)
